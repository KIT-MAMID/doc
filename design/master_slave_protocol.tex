\section{MasterSlaveProtocol}
\renewcommand{\gocurpackage}{msp}

\begin{figure}[H]
	\includegraphics[width=\textwidth]{msp_classes}
	\caption{MasterSlaveProtocol}
\end{figure}

The MasterSlaveProtocol \refgo{msp} implements communication between \refgo{slave} and \refgo{master}.\\
There are two structures which may be sent directly over HTTP as request body, represented with JSON:
\begin{itemize}
  \item \codeinline{[]\reftype{Mongod}} An array of descriptions of all mongod instances of that \refgo{slave}.
  \item \codeinline{\reftype{SlaveError}} Sent (only) by \refgo{slave} in case there are general problems preventing observation of any running mongod instances.
\end{itemize}

For several datastructures in \refgo{msp}, similar ones exist in  \refgo{model}. The reasoning behind this is the desire to have a
stable protocol format for the \refgo{msp}: the JSON objects are auto-generated during runtime via reflection.
Hence, duplication of datastructures is a necessary tradeoff in order to sustain the principle of information hiding.

% server (slave) side structures
\struct{Listener}{
  Structure for handling communication through the MasterSlaveProtocol on the \refgo{slave} side.
}{
  \property{Consumer}[\reftype{Consumer}]{
    Reference to an event handler, typically a controller.
  }
}{
  \method{Run}{
    Start listening for connections using the MasterSlaveProtocol.
    \begin{itemize}
      \item Listen for incoming connections from the \refgo{master}.
      \item Decode / Encode the transport format.
      \item Validate incoming request format.
      \item Delegate valid requests to the \reftype{Consumer}.
    \end{itemize}
  }
}

\interface{Consumer}{
  A Consumer handles MasterSlaveProtocol requests received by an instance of \reftype{Listener}.
}{
  \method{RequestStatus}[{(\reftype{SlaveStatus}, \reftype{SlaveError})}]{
    %TODO reference request message object here -> proto specification
    Request to provide a status report of the slave's state.
    See \reftype{Mongod} for details on the data returned by this method.
  }
  \method{EstablishMongodState}[*\reftype{SlaveError}](
    \param{m}[\reftype{Mongod}]{State description of a mongod instance that shall be established}
  ){
    %TODO reference request message object here -> proto specification
    Request to establish the configuration state $m$ of a MongoDB process on the slave.
    May return an error in case the state could not be established.
  }
}


% client (master) side structures
\struct{Client}{
  Structure for handling communication through the MasterSlaveProtocol on the \refgo{master} side.
}{
  \item \textit{none}
}{
  \method{RequestStatus}[{([]\reftype{Mongod}, \reftype{error})}]{
    Send a status request to the \refgo{slave} to retrieve all the running \reftype{Mongod} instances. May return an instance of \reftype{error} in case overall retrieving failed.
  }
  \method{EstablishMongodState}[*\reftype{CommunicationError}](
    \param{m}[[]\reftype{Mongod}]{Array of \reftype{Mongod} instances to establish}
  ){
    Sends the array of \reftype{Mongod} instances to the \refgo{slave} which is tasked with creating and configuring the described processes.
  }
}


% protocol specific structures
\struct{Mongod}{
  Description of a mongod instance.
}{
  \property{Port}[\reftype{PortNumber}]{The port the mongod instance listens on}
  \property{ReplicaSetName}[string]{Identifier for the replica set the mongod instance participates in}
  \property{ShardingConfigServer}[bool]
  \property{StatusError}[*\reftype{SlaveError}]{Set by \refgo{slave} when the described mongod instance errored}
  \property{LastEstablishStateError}[*\reftype{SlaveError}]{The last \reftype{SlaveError} created upon trying to establish state (\codeinline{nil} when sent by \refgo{master} or when state has successfully been established since the last establish request)}
  \property{State}[\reftype{MongodState}]{State the mongod instance is in}
  \property{ReplicaSetMembers}[[]\reftype{HostPort}]{Targets to connect the ReplicaSet to}
}

\goenum{MongodState}{
  Describes the state of a Mongod instance controlled by the slave.

}{
  \goenumitem{MongodStateDestroyed}{The Mongod instance is not running and all related data stored on the \refgo{slave} host is deleted. (only sent by \refgo{master})}
  \goenumitem{MongodStateNotRunning}{The Mongod instance is not running but related data may be stored on the \refgo{slave}.}
  \goenumitem{MongodStateRecovering}{The Mongod is running but not available for reads because data needs to be synced from other Replica Set members.
                                     This is a common case when adding new members to an existing Replica Set. (only sent by \refgo{slave})}
  \goenumitem{MongodStateRunning}{The Mongod instance is running and in sync with other Replica Set members.}
}

\struct{HostPort}{
  Container for a hostname\&port pair.
}{
  \property{Hostname}[string]
  \property{Port}[\reftype{PortNumber}]
}

\typealias{PortNumber}[uint16]{
  A TCP port number as specified in \href{https://tools.ietf.org/html/rfc793\#section-3.1}{RFC 793 Section 3.1}.
}

\interface{error}{
  Generic interface for errors of the MasterSlaveProtocol. The \refgo{master.ProblemManager} will have to deal with the specific types of errors.
}

\struct{SlaveError}{
  Description of an error in the slave, usually corresponding to a partial error when executing a request from the master.
  See \refgo{msp.Mongod} for examples.
}{
  \property{Identifier}[string]{Unique identifier for the type of errror defined by the slave. Intended for communicating errors,
                                e.g. in a remote support situation. }
  \property{Description}[string]{Short human-readable description of the error, suitable for display in subject lines, etc.}
  \property{LongDescription}[string]{Long human-readable description of the error.\\
                                     Can contain the \codeinline{error.Error()} of one or more underlying errors or other useful
                                     information for further debugging.}
}

\struct{CommunicationError}{
  Description of an error generated on the \refgo{msp.MSPClient} side in case it cannot communicate properly with the \refgo{slave},
  e.g. when reading or writing to the socket fails or the connection times out.
}{
  \property{Message}[string]{Failure message from internal Go functions or message about the timeout.}
}
